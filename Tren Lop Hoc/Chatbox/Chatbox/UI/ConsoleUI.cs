using Chatbox.Models;

namespace Chatbox.UI
{
    public static class ConsoleUI
    {
        private static ChatTheme _currentTheme = ChatTheme.Default;

        public static void SetTheme(ChatTheme theme)
        {
            _currentTheme = theme;
            ApplyTheme();
        }

        private static void ApplyTheme()
        {
            switch (_currentTheme)
            {
                case ChatTheme.Dark:
                    Console.BackgroundColor = ConsoleColor.Black;
                    Console.ForegroundColor = ConsoleColor.White;
                    break;
                case ChatTheme.Light:
                    Console.BackgroundColor = ConsoleColor.White;
                    Console.ForegroundColor = ConsoleColor.Black;
                    break;
                case ChatTheme.Colorful:
                    Console.BackgroundColor = ConsoleColor.DarkBlue;
                    Console.ForegroundColor = ConsoleColor.Yellow;
                    break;
                default:
                    Console.BackgroundColor = ConsoleColor.Black;
                    Console.ForegroundColor = ConsoleColor.Gray;
                    break;
            }
            Console.Clear();
        }

        public static void ShowHeader(string sessionName, string userName)
        {
            Console.Clear();
            var headerColor = GetThemeColor("header");
            
            Console.ForegroundColor = headerColor;
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("?                               ?? CHATBOX                                    ?");
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine($"? Session: {sessionName.PadRight(25)} ? User: {userName.PadRight(25)} ?");
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("? L?nh: /help - Tr? giúp | /templates - M?u tin nh?n | /exit - Thoát       ?");
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.ResetColor();
            Console.WriteLine();
        }

        public static void DisplayMessage(Message message, bool isCurrentUser = false)
        {
            var timestamp = message.Timestamp.ToString("HH:mm");
            var maxWidth = Console.WindowWidth - 20;
            var content = WrapText(message.Content, maxWidth);

            switch (message.Type)
            {
                case MessageType.User:
                    if (isCurrentUser)
                    {
                        Console.ForegroundColor = GetThemeColor("userMessage");
                        Console.WriteLine($"?? B?n ({timestamp}) ??????????????????????????????");
                        foreach (var line in content)
                        {
                            Console.WriteLine($"? {line.PadRight(maxWidth)} ?");
                        }
                        Console.WriteLine("???????????????????????????????????????????????????");
                    }
                    else
                    {
                        Console.ForegroundColor = GetThemeColor("otherMessage");
                        Console.WriteLine($"?? {message.Author} ({timestamp}) ???????????????????");
                        foreach (var line in content)
                        {
                            Console.WriteLine($"? {line.PadRight(maxWidth)} ?");
                        }
                        Console.WriteLine("???????????????????????????????????????????????????");
                    }
                    break;
                    
                case MessageType.System:
                    Console.ForegroundColor = GetThemeColor("system");
                    Console.WriteLine($"?? {message.Content}");
                    break;
                    
                case MessageType.Bot:
                    Console.ForegroundColor = GetThemeColor("bot");
                    Console.WriteLine($"?? Bot: {message.Content}");
                    break;
            }
            
            Console.ResetColor();
            Console.WriteLine();
        }

        public static void DisplayTemplateMenu(string[] categories)
        {
            Console.ForegroundColor = GetThemeColor("menu");
            Console.WriteLine("?????????????????????????????????????????");
            Console.WriteLine("?           DANH M?C M?U TIN NH?N       ?");
            Console.WriteLine("?????????????????????????????????????????");
            
            for (int i = 0; i < categories.Length; i++)
            {
                Console.WriteLine($"? {(i + 1).ToString().PadLeft(2)}. {categories[i].PadRight(32)} ?");
            }
            
            Console.WriteLine("?  0. Quay l?i                         ?");
            Console.WriteLine("?????????????????????????????????????????");
            Console.ResetColor();
        }

        public static void DisplayTemplates(string category, string[] templates)
        {
            Console.ForegroundColor = GetThemeColor("templates");
            Console.WriteLine($"?????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine($"?                        M?U TIN NH?N - {category.ToUpper()}                        ?");
            Console.WriteLine("?????????????????????????????????????????????????????????????????????????????????");
            
            for (int i = 0; i < templates.Length; i++)
            {
                var wrappedText = WrapText(templates[i], 70);
                Console.WriteLine($"? {(i + 1).ToString().PadLeft(2)}. {wrappedText[0].PadRight(72)} ?");
                for (int j = 1; j < wrappedText.Count; j++)
                {
                    Console.WriteLine($"?     {wrappedText[j].PadRight(72)} ?");
                }
            }
            
            Console.WriteLine("?  0. Quay l?i                                                                 ?");
            Console.WriteLine("?????????????????????????????????????????????????????????????????????????????????");
            Console.ResetColor();
        }

        public static void DisplaySessionList(List<ChatSession> sessions)
        {
            Console.ForegroundColor = GetThemeColor("sessionList");
            Console.WriteLine("?????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("?                              DANH SÁCH PHIÊN CHAT                            ?");
            Console.WriteLine("???????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("? STT ? Tên phiên                 ? Ng??i dùng        ? L?n cu?i ho?t ??ng    ?");
            Console.WriteLine("???????????????????????????????????????????????????????????????????????????????");
            
            for (int i = 0; i < sessions.Count; i++)
            {
                var session = sessions[i];
                var name = session.Name.Length > 23 ? session.Name.Substring(0, 20) + "..." : session.Name;
                var user = session.CurrentUser.Length > 15 ? session.CurrentUser.Substring(0, 12) + "..." : session.CurrentUser;
                var lastActivity = session.LastActivity.ToString("dd/MM HH:mm");
                
                Console.WriteLine($"? {(i + 1).ToString().PadLeft(3)} ? {name.PadRight(25)} ? {user.PadRight(17)} ? {lastActivity.PadRight(21)} ?");
            }
            
            Console.WriteLine("???????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("? Nh?p s? ?? ch?n phiên chat, 'n' ?? t?o m?i, ho?c 'q' ?? thoát             ?");
            Console.WriteLine("?????????????????????????????????????????????????????????????????????????????????");
            Console.ResetColor();
        }

        public static void ShowInputPrompt(string userName)
        {
            Console.ForegroundColor = GetThemeColor("input");
            Console.Write($"?? {userName}: ");
            Console.ResetColor();
        }

        public static void ShowError(string message)
        {
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine($"? {message}");
            Console.ResetColor();
        }

        public static void ShowSuccess(string message)
        {
            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"? {message}");
            Console.ResetColor();
        }

        public static void ShowInfo(string message)
        {
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"??  {message}");
            Console.ResetColor();
        }

        public static void ShowHelp()
        {
            Console.ForegroundColor = GetThemeColor("help");
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("?                                TR? GIÚP                                     ?");
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.WriteLine("? /help        - Hi?n th? tr? giúp                                            ?");
            Console.WriteLine("? /templates   - Xem danh sách m?u tin nh?n                                   ?");
            Console.WriteLine("? /sessions    - Qu?n lý phiên chat                                           ?");
            Console.WriteLine("? /theme       - Thay ??i giao di?n (default/dark/light/colorful)             ?");
            Console.WriteLine("? /clear       - Xóa màn hình                                                 ?");
            Console.WriteLine("? /exit        - Thoát ch??ng trình                                           ?");
            Console.WriteLine("?                                                                              ?");
            Console.WriteLine("? M?o: Gõ tin nh?n bình th??ng ?? chat, s? d?ng emoji ?? sinh ??ng h?n! ??   ?");
            Console.WriteLine("????????????????????????????????????????????????????????????????????????????????");
            Console.ResetColor();
            Console.WriteLine();
        }

        private static ConsoleColor GetThemeColor(string element)
        {
            return _currentTheme switch
            {
                ChatTheme.Dark => element switch
                {
                    "header" => ConsoleColor.Cyan,
                    "userMessage" => ConsoleColor.Green,
                    "otherMessage" => ConsoleColor.Yellow,
                    "system" => ConsoleColor.Magenta,
                    "bot" => ConsoleColor.Blue,
                    "menu" => ConsoleColor.White,
                    "templates" => ConsoleColor.Yellow,
                    "sessionList" => ConsoleColor.Cyan,
                    "input" => ConsoleColor.Green,
                    "help" => ConsoleColor.White,
                    _ => ConsoleColor.Gray
                },
                ChatTheme.Light => element switch
                {
                    "header" => ConsoleColor.DarkBlue,
                    "userMessage" => ConsoleColor.DarkGreen,
                    "otherMessage" => ConsoleColor.DarkMagenta,
                    "system" => ConsoleColor.DarkRed,
                    "bot" => ConsoleColor.DarkBlue,
                    "menu" => ConsoleColor.Black,
                    "templates" => ConsoleColor.DarkYellow,
                    "sessionList" => ConsoleColor.DarkCyan,
                    "input" => ConsoleColor.DarkGreen,
                    "help" => ConsoleColor.Black,
                    _ => ConsoleColor.DarkGray
                },
                ChatTheme.Colorful => element switch
                {
                    "header" => ConsoleColor.Yellow,
                    "userMessage" => ConsoleColor.Green,
                    "otherMessage" => ConsoleColor.Magenta,
                    "system" => ConsoleColor.Red,
                    "bot" => ConsoleColor.Cyan,
                    "menu" => ConsoleColor.White,
                    "templates" => ConsoleColor.Yellow,
                    "sessionList" => ConsoleColor.Cyan,
                    "input" => ConsoleColor.Green,
                    "help" => ConsoleColor.White,
                    _ => ConsoleColor.Gray
                },
                _ => element switch
                {
                    "header" => ConsoleColor.White,
                    "userMessage" => ConsoleColor.Green,
                    "otherMessage" => ConsoleColor.Yellow,
                    "system" => ConsoleColor.Cyan,
                    "bot" => ConsoleColor.Blue,
                    "menu" => ConsoleColor.White,
                    "templates" => ConsoleColor.Yellow,
                    "sessionList" => ConsoleColor.White,
                    "input" => ConsoleColor.Green,
                    "help" => ConsoleColor.White,
                    _ => ConsoleColor.Gray
                }
            };
        }

        private static List<string> WrapText(string text, int maxWidth)
        {
            var lines = new List<string>();
            var words = text.Split(' ');
            var currentLine = "";

            foreach (var word in words)
            {
                if (currentLine.Length + word.Length + 1 <= maxWidth)
                {
                    currentLine += (currentLine.Length > 0 ? " " : "") + word;
                }
                else
                {
                    if (currentLine.Length > 0)
                    {
                        lines.Add(currentLine);
                        currentLine = word;
                    }
                    else
                    {
                        lines.Add(word);
                    }
                }
            }

            if (currentLine.Length > 0)
            {
                lines.Add(currentLine);
            }

            return lines;
        }

        public static void WaitForKeyPress(string message = "Nh?n phím b?t k? ?? ti?p t?c...")
        {
            Console.ForegroundColor = ConsoleColor.DarkGray;
            Console.WriteLine(message);
            Console.ResetColor();
            Console.ReadKey(true);
        }
    }
}