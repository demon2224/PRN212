using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using LAB2710.Models;
using LAB2710.Services;
using Microsoft.Win32;
using System.Collections.ObjectModel;
using System.IO;
using System.Text.Json;
using System.Windows;

namespace LAB2710.ViewModels
{
    public partial class ManagePageViewModel : BaseViewModel
    {
        private readonly GameService _gameService;

        [ObservableProperty]
        private ObservableCollection<Game> games = new();

        [ObservableProperty]
        private Game? selectedGame;

        [ObservableProperty]
        private string searchText = string.Empty;

        [ObservableProperty]
        private string title = string.Empty;

        [ObservableProperty]
        private string genre = string.Empty;

        [ObservableProperty]
        private double? price;

        [ObservableProperty]
        private DateTime? releaseDate;

        [ObservableProperty]
        private bool isEditing = false;

        private int editingGameId = 0;

        public ManagePageViewModel()
        {
            _gameService = new GameService();
            _ = LoadGamesAsync();
        }

        [RelayCommand]
        private async Task LoadGamesAsync()
        {
            try
            {
                var gameList = await _gameService.GetAllGamesAsync();
                Games.Clear();
                foreach (var game in gameList)
                {
                    Games.Add(game);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error loading games: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        [RelayCommand]
        private async Task SearchAsync()
        {
            try
            {
                if (string.IsNullOrWhiteSpace(SearchText))
                {
                    await LoadGamesAsync();
                }
                else
                {
                    var searchResults = await _gameService.SearchGamesByTitleAsync(SearchText);
                    Games.Clear();
                    foreach (var game in searchResults)
                    {
                        Games.Add(game);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error searching games: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        [RelayCommand]
        private async Task SaveAsync()
        {
            try
            {
                if (string.IsNullOrWhiteSpace(Title))
                {
                    MessageBox.Show("Title is required!", "Validation Error", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                var game = new Game
                {
                    Title = Title,
                    Genre = Genre,
                    Price = Price,
                    ReleaseDate = ReleaseDate
                };

                bool success;
                if (IsEditing)
                {
                    game.GameId = editingGameId;
                    success = await _gameService.UpdateGameAsync(game);
                }
                else
                {
                    success = await _gameService.AddGameAsync(game);
                }

                if (success)
                {
                    MessageBox.Show(IsEditing ? "Game updated successfully!" : "Game added successfully!", 
                        "Success", MessageBoxButton.OK, MessageBoxImage.Information);
                    ClearForm();
                    await LoadGamesAsync();
                }
                else
                {
                    MessageBox.Show("Failed to save game!", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error saving game: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        [RelayCommand]
        private void Edit()
        {
            if (SelectedGame != null)
            {
                Title = SelectedGame.Title;
                Genre = SelectedGame.Genre ?? string.Empty;
                Price = SelectedGame.Price;
                ReleaseDate = SelectedGame.ReleaseDate;
                IsEditing = true;
                editingGameId = SelectedGame.GameId;
            }
        }

        [RelayCommand]
        private async Task DeleteAsync()
        {
            if (SelectedGame != null)
            {
                var result = MessageBox.Show($"Are you sure you want to delete '{SelectedGame.Title}'?", 
                    "Confirm Delete", MessageBoxButton.YesNo, MessageBoxImage.Question);
                
                if (result == MessageBoxResult.Yes)
                {
                    try
                    {
                        var success = await _gameService.DeleteGameAsync(SelectedGame.GameId);
                        if (success)
                        {
                            MessageBox.Show("Game deleted successfully!", "Success", 
                                MessageBoxButton.OK, MessageBoxImage.Information);
                            await LoadGamesAsync();
                        }
                        else
                        {
                            MessageBox.Show("Failed to delete game!", "Error", 
                                MessageBoxButton.OK, MessageBoxImage.Error);
                        }
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"Error deleting game: {ex.Message}", "Error", 
                            MessageBoxButton.OK, MessageBoxImage.Error);
                    }
                }
            }
        }

        [RelayCommand]
        private void Clear()
        {
            ClearForm();
        }

        [RelayCommand]
        private void ExportToJson()
        {
            try
            {
                var saveFileDialog = new SaveFileDialog
                {
                    Filter = "JSON files (*.json)|*.json",
                    DefaultExt = "json",
                    FileName = "games.json"
                };

                if (saveFileDialog.ShowDialog() == true)
                {
                    var options = new JsonSerializerOptions
                    {
                        WriteIndented = true
                    };

                    var json = JsonSerializer.Serialize(Games.ToList(), options);
                    File.WriteAllText(saveFileDialog.FileName, json);
                    
                    MessageBox.Show("Games exported successfully!", "Success", 
                        MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error exporting games: {ex.Message}", "Error", 
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void ClearForm()
        {
            Title = string.Empty;
            Genre = string.Empty;
            Price = null;
            ReleaseDate = null;
            IsEditing = false;
            editingGameId = 0;
        }
    }
}